<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Markdown Kanban</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--vscode-font-family);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            margin: 0;
            padding: 20px;
            overflow-x: auto;
        }

        .kanban-board {
            display: flex;
            gap: 20px;
            min-height: calc(100vh - 150px);
            padding-bottom: 20px;
        }

        .kanban-column {
            background-color: var(--vscode-sideBar-background);
            border-radius: 8px;
            padding: 16px;
            min-width: 300px;
            max-width: 350px;
            flex-shrink: 0;
            border: 1px solid var(--vscode-panel-border);
            position: relative;
        }

        .kanban-column.dragging {
            opacity: 0.5;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--vscode-panel-border);
        }

        .column-title-section {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .drag-handle {
            color: var(--vscode-descriptionForeground);
            cursor: grab;
            font-size: 14px;
            opacity: 0.4;
            transition: opacity 0.2s;
            user-select: none;
            flex-shrink: 0;
        }

        .drag-handle:hover {
            opacity: 0.8;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .column-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--vscode-foreground);
            flex: 1;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            min-width: 0;
            word-break: break-word;
        }

        .column-title:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .column-title-edit {
            font-size: 14px;
            font-weight: 600;
            color: var(--vscode-foreground);
            flex: 1;
            border: 1px solid var(--vscode-focusBorder);
            border-radius: 3px;
            padding: 2px 4px;
            background: var(--vscode-input-background);
            width: 100%;
            resize: none;
            overflow: hidden;
            min-height: 24px;
            font-family: inherit;
        }

        .column-title-edit:focus {
            outline: none;
            border-color: var(--vscode-focusBorder);
        }

        .column-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .task-count {
            background-color: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Donut Menu Styles */
        .donut-menu {
            position: relative;
        }

        .donut-menu-btn {
            background: none;
            border: none;
            color: var(--vscode-foreground);
            cursor: pointer;
            padding: 4px;
            font-size: 18px;
            line-height: 1;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .donut-menu-btn:hover {
            opacity: 1;
        }

        .donut-menu-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--vscode-dropdown-background);
            border: 1px solid var(--vscode-dropdown-border);
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 150px;
        }

        .donut-menu.active .donut-menu-dropdown {
            display: block;
        }

        .donut-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            color: var(--vscode-dropdown-foreground);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            transition: background-color 0.2s;
            white-space: nowrap;
            display: block;
        }

        button.donut-menu-item {
            width: 100%;
            text-align: left;
        }

        .donut-menu-item:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .donut-menu-item.has-submenu {
            position: relative;
            padding-right: 24px;
        }

        .donut-menu-item.has-submenu::after {
            content: '▶';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            opacity: 0.6;
        }

        .donut-menu-submenu button.donut-menu-item {
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
            padding: 8px 12px;
            margin: 0;
        }

        .donut-menu-submenu button.donut-menu-item:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        /* .donut-menu-submenu {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            background: var(--vscode-dropdown-background);
            border: 1px solid var(--vscode-dropdown-border);
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            min-width: 120px;
            z-index: 1001;
        }

        .donut-menu-item.has-submenu:hover .donut-menu-submenu {
            display: block;
        } */

        .donut-menu-submenu button.donut-menu-item {
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
            padding: 8px 12px;
            margin: 0;
        }

        .donut-menu-submenu button.donut-menu-item:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .donut-menu-divider {
            height: 1px;
            background: var(--vscode-panel-border);
            margin: 4px 0;
        }

        /* Task Menu Overlay Position */
        .task-menu-container {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
        }

        /* Task Styles */
        .tasks-container {
            min-height: 100px;
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }

        .task-item {
            background-color: var(--vscode-editor-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            position: relative;
        }

        .task-item:hover {
            border-color: var(--vscode-focusBorder);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .task-header {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 4px;
        }

        .task-drag-handle {
            color: var(--vscode-descriptionForeground);
            cursor: grab;
            font-size: 14px;
            opacity: 0.4;
            transition: opacity 0.2s;
            flex-shrink: 0;
            line-height: 1;
            margin-top: 2px;
            user-select: none;
        }

        .task-item:hover .task-drag-handle {
            opacity: 0.8;
        }

        .task-drag-handle:hover {
            opacity: 1;
            color: var(--vscode-foreground);
        }

        .task-drag-handle:active {
            cursor: grabbing;
        }

        .task-title-container {
            flex: 1;
            min-width: 0;
        }

        .task-title-display {
            font-size: 14px;
            font-weight: 500;
            color: var(--vscode-foreground);
            line-height: 1.4;
            word-break: break-word;
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
            min-height: 20px;
        }

        .task-title-display:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .task-title-edit {
            font-size: 14px;
            font-weight: 500;
            color: var(--vscode-foreground);
            line-height: 1.4;
            word-break: break-word;
            border: 1px solid var(--vscode-focusBorder);
            border-radius: 3px;
            padding: 2px 4px;
            background: var(--vscode-input-background);
            width: 100%;
            resize: none;
            overflow: hidden;
            min-height: 24px;
            font-family: inherit;
        }

        .task-title-edit:focus {
            outline: none;
            border-color: var(--vscode-focusBorder);
        }

        .task-description-container {
            margin-top: 4px;
            padding-right: 30px; /* Space for menu button */
        }

        .task-description-display {
            color: var(--vscode-descriptionForeground);
            font-size: 13px;
            line-height: 1.5;
            padding: 4px;
            border-radius: 3px;
            cursor: pointer;
            min-height: 20px;
        }

        .task-description-display:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .task-description-edit {
            color: var(--vscode-descriptionForeground);
            font-size: 13px;
            line-height: 1.5;
            border: 1px solid var(--vscode-focusBorder);
            border-radius: 3px;
            padding: 4px;
            background: var(--vscode-input-background);
            width: 100%;
            resize: none;
            overflow: hidden;
            min-height: 3em;
            font-family: inherit;
        }

        .task-description-edit:focus {
            outline: none;
            border-color: var(--vscode-focusBorder);
        }

        .task-description-placeholder {
            color: var(--vscode-descriptionForeground);
            font-size: 13px;
            font-style: italic;
            opacity: 0.7;
            padding: 4px;
            cursor: pointer;
            border-radius: 3px;
        }

        .task-description-placeholder:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .task-title-placeholder {
            color: var(--vscode-descriptionForeground);
            font-style: italic;
            opacity: 0.7;
        }

        .add-task-btn {
            width: 100%;
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: 1px dashed var(--vscode-panel-border);
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        .add-task-btn:hover {
            background: var(--vscode-button-secondaryHoverBackground);
            border-color: var(--vscode-focusBorder);
        }

        .add-column-btn {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 6px;
            padding: 16px;
            min-width: 200px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            align-self: flex-start;
        }

        .add-column-btn:hover {
            background: var(--vscode-button-hoverBackground);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--vscode-editor-background);
            margin: 10% auto;
            padding: 20px;
            border: 1px solid var(--vscode-panel-border);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--vscode-panel-border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--vscode-foreground);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--vscode-input-border);
            border-radius: 4px;
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            font-family: inherit;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--vscode-focusBorder);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--vscode-panel-border);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }

        .btn-primary:hover {
            background: var(--vscode-button-hoverBackground);
        }

        .btn-secondary {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }

        .btn-secondary:hover {
            background: var(--vscode-button-secondaryHoverBackground);
        }

        /* Drag styles */
        .task-item.dragging {
            opacity: 0.5;
        }

        .kanban-column.drag-over {
            background-color: var(--vscode-list-hoverBackground);
        }

        .task-item.drag-insert-before {
            border-top: 3px solid var(--vscode-focusBorder);
            margin-top: 3px;
        }

        .task-item.drag-insert-after {
            border-bottom: 3px solid var(--vscode-focusBorder);
            margin-bottom: 3px;
        }

        .kanban-column.column-dragging {
            opacity: 0.6;
            transform: scale(0.95);
        }

        /* Markdown content styles */
        .markdown-content {
            word-wrap: break-word;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin: 0.25em 0 0.125em 0;
            color: var(--vscode-foreground);
        }

        .markdown-content p {
            margin: 0.125em 0;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin: 0.125em 0;
            padding-left: 1.5em;
        }

        .markdown-content code {
            background-color: var(--vscode-textCodeBlock-background);
            color: var(--vscode-textPreformat-foreground);
            padding: 0.1em 0.3em;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background-color: var(--vscode-textCodeBlock-background);
            color: var(--vscode-textPreformat-foreground);
            padding: 0.5em;
            border-radius: 3px;
            overflow-x: auto;
            margin: 0.25em 0;
        }

        .markdown-content a {
            color: var(--vscode-textLink-foreground);
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .task-title-container .markdown-content h1,
        .task-title-container .markdown-content h2,
        .task-title-container .markdown-content h3,
        .task-title-container .markdown-content h4,
        .task-title-container .markdown-content h5,
        .task-title-container .markdown-content h6 {
            margin: 0;
            font-size: inherit;
            line-height: inherit;
        }

        .task-title-container .markdown-content p {
            margin: 0;
            display: inline;
        }

        .task-title-container .markdown-content {
            display: inline;
        }
    </style>
</head>
<body>
    <div id="kanban-container">
        <div class="kanban-board" id="kanban-board">
            <!-- Kanban content will be dynamically generated -->
        </div>
    </div>

    <!-- Input modal -->
    <div id="input-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="input-modal-title">Enter Value</h3>
                <button class="close-btn" onclick="closeInputModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="input-modal-message">Please enter a value:</p>
                <input type="text" id="input-modal-field" class="form-input" placeholder="Enter value..." />
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeInputModal()">Cancel</button>
                <button type="button" class="btn btn-primary" id="input-ok-btn">OK</button>
            </div>
        </div>
    </div>

    <script>
        // VS Code API mock for testing (replace with actual vscode API in extension)
        const vscode = typeof acquireVsCodeApi !== 'undefined' ? acquireVsCodeApi() : {
            postMessage: (msg) => console.log('Message to extension:', msg)
        };

        let currentBoard = null;
        let editingTask = null;
        let scrollPositions = new Map(); // Store scroll positions

        // Initialize with sample data for testing
        if (typeof acquireVsCodeApi === 'undefined') {
            currentBoard = {
                title: 'Sample Kanban Board',
                columns: [
                    {
                        id: 'col1',
                        title: 'To Do',
                        tasks: [
                            { id: 'task1', title: '**Important** Task', description: 'This is a sample task with *markdown* support' },
                            { id: 'task2', title: 'Another Task', description: 'More description here\n\nWith multiple lines' }
                        ]
                    },
                    {
                        id: 'col2',
                        title: 'In Progress',
                        tasks: [
                            { id: 'task3', title: 'Working on this', description: '' }
                        ]
                    },
                    {
                        id: 'col3',
                        title: 'Done',
                        tasks: []
                    }
                ]
            };
            setTimeout(() => renderBoard(), 100);
        }

        // Listen for messages from the extension
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.type) {
                case 'updateBoard':
                    currentBoard = message.board;
                    renderBoard();
                    break;
            }
        });

        // Render Kanban board
        function renderBoard() {
            if (!currentBoard) return;

            const boardElement = document.getElementById('kanban-board');
            
            // Save current scroll positions
            document.querySelectorAll('.tasks-container').forEach(container => {
                const columnId = container.id.replace('tasks-', '');
                scrollPositions.set(columnId, container.scrollTop);
            });

            boardElement.innerHTML = '';

            // Render columns
            currentBoard.columns.forEach((column, index) => {
                const columnElement = createColumnElement(column, index);
                boardElement.appendChild(columnElement);
            });

            const addColumnBtn = document.createElement('button');
            addColumnBtn.className = 'add-column-btn';
            addColumnBtn.textContent = '+ Add Column';
            addColumnBtn.onclick = () => addColumn();
            boardElement.appendChild(addColumnBtn);

            // Restore scroll positions
            setTimeout(() => {
                scrollPositions.forEach((scrollTop, columnId) => {
                    const container = document.getElementById(`tasks-${columnId}`);
                    if (container) {
                        container.scrollTop = scrollTop;
                    }
                });
            }, 0);

            setupDragAndDrop();
        }

        function createColumnElement(column, columnIndex) {
            const columnDiv = document.createElement('div');
            columnDiv.className = 'kanban-column';
            columnDiv.setAttribute('data-column-id', column.id);
            columnDiv.setAttribute('data-column-index', columnIndex);

            columnDiv.innerHTML = `
                <div class="column-header">
                    <div class="column-title-section">
                        <span class="drag-handle" draggable="true">⋮⋮</span>
                        <h3 class="column-title" onclick="editColumnTitle('${column.id}')">${escapeHtml(column.title)}</h3>
                        <textarea class="column-title-edit" 
                                 data-column-id="${column.id}"
                                 style="display: none;">${escapeHtml(column.title)}</textarea>
                    </div>
                    <div class="column-controls">
                        <span class="task-count">${column.tasks.length}</span>
                        <div class="donut-menu">
                            <button class="donut-menu-btn" onclick="toggleDonutMenu(event, this)">⋯</button>
                            <div class="donut-menu-dropdown">
                                <button class="donut-menu-item" onclick="insertColumnBefore('${column.id}')">Insert list before</button>
                                <button class="donut-menu-item" onclick="insertColumnAfter('${column.id}')">Insert list after</button>
                                <div class="donut-menu-divider"></div>
                                <div class="donut-menu-item has-submenu">
                                    Sort by
                                    <div class="donut-menu-submenu">
                                        <button class="donut-menu-item" onclick="sortColumn('${column.id}', 'unsorted')">Unsorted</button>
                                        <button class="donut-menu-item" onclick="sortColumn('${column.id}', 'title')">Sort by title</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tasks-container" id="tasks-${column.id}">
                    ${column.tasks.map((task, index) => createTaskElement(task, column.id, index)).join('')}
                </div>
                <button class="add-task-btn" onclick="addTask('${column.id}')">
                    + Add Task
                </button>
            `;

            return columnDiv;
        }

        function createTaskElement(task, columnId, taskIndex) {
            const renderedDescription = task.description ? renderMarkdown(task.description) : '';
            const renderedTitle = task.title ? renderMarkdown(task.title) : '';
            
            return `
                <div class="task-item" data-task-id="${task.id}" data-column-id="${columnId}" data-task-index="${taskIndex}">
                    <div class="task-menu-container">
                        <div class="donut-menu">
                            <button class="donut-menu-btn" onclick="toggleDonutMenu(event, this)">⋯</button>
                            <div class="donut-menu-dropdown">
                                <button class="donut-menu-item" onclick="duplicateTask('${task.id}', '${columnId}')">Duplicate card</button>
                                <button class="donut-menu-item" onclick="insertTaskBefore('${task.id}', '${columnId}')">Insert card before</button>
                                <button class="donut-menu-item" onclick="insertTaskAfter('${task.id}', '${columnId}')">Insert card after</button>
                                <div class="donut-menu-divider"></div>
                                <button class="donut-menu-item" onclick="moveTaskToTop('${task.id}', '${columnId}')">Move to top</button>
                                <button class="donut-menu-item" onclick="moveTaskUp('${task.id}', '${columnId}')">Move up</button>
                                <button class="donut-menu-item" onclick="moveTaskDown('${task.id}', '${columnId}')">Move down</button>
                                <button class="donut-menu-item" onclick="moveTaskToBottom('${task.id}', '${columnId}')">Move to bottom</button>
                                <div class="donut-menu-divider"></div>
                                <div class="donut-menu-item has-submenu">
                                    Move to list
                                    <div class="donut-menu-submenu">
                                        ${currentBoard.columns.map(col => 
                                            col.id !== columnId ? 
                                            `<button class="donut-menu-item" onclick="moveTaskToColumn('${task.id}', '${columnId}', '${col.id}')">${escapeHtml(col.title)}</button>` : ''
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="task-header">
                        <div class="task-drag-handle" title="Drag to move task">⋮⋮</div>
                        <div class="task-title-container">
                            <div class="task-title-display markdown-content" 
                                 data-task-id="${task.id}" 
                                 data-column-id="${columnId}"
                                 onclick="editTitle(this)">${renderedTitle || '<span class="task-title-placeholder">Add title...</span>'}</div>
                            <textarea class="task-title-edit" 
                                     data-task-id="${task.id}" 
                                     data-column-id="${columnId}"
                                     data-field="title"
                                     placeholder="Task title (Markdown supported)..."
                                     style="display: none;">${escapeHtml(task.title || '')}</textarea>
                        </div>
                    </div>

                    <div class="task-description-container">
                        <div class="task-description-display markdown-content" 
                             data-task-id="${task.id}" 
                             data-column-id="${columnId}"
                             onclick="editDescription(this)"
                             style="${task.description ? '' : 'display: none;'}">${renderedDescription}</div>
                        <textarea class="task-description-edit" 
                                 data-task-id="${task.id}" 
                                 data-column-id="${columnId}"
                                 data-field="description"
                                 placeholder="Add description (Markdown supported)..."
                                 style="display: none;">${escapeHtml(task.description || '')}</textarea>
                        ${!task.description ? `<div class="task-description-placeholder" onclick="editDescription(this, '${task.id}', '${columnId}')">Add description...</div>` : ''}
                    </div>
                </div>
            `;
        }

        // Donut menu functions
        function toggleDonutMenu(event, button) {
            event.stopPropagation();
            const menu = button.parentElement;
            const wasActive = menu.classList.contains('active');
            
            // Close all other menus
            document.querySelectorAll('.donut-menu').forEach(m => {
                m.classList.remove('active');
            });
            
            // Toggle this menu
            if (!wasActive) {
                menu.classList.add('active');
            }
        }

        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            // Close menus if clicking outside or on a button (action item)
            if (!e.target.closest('.donut-menu') || e.target.matches('button.donut-menu-item')) {
                document.querySelectorAll('.donut-menu').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        });

        // Column title editing
        function editColumnTitle(columnId) {
            const column = document.querySelector(`[data-column-id="${columnId}"]`);
            const titleElement = column.querySelector('.column-title');
            const editElement = column.querySelector('.column-title-edit');
            const dragHandle = column.querySelector('.drag-handle');
            
            titleElement.style.display = 'none';
            editElement.style.display = 'block';
            dragHandle.draggable = false; // Disable dragging while editing
            
            editElement.focus();
            editElement.select();
            
            const saveTitle = () => {
                const newTitle = editElement.value.trim();
                if (newTitle) {
                    vscode.postMessage({
                        type: 'editColumnTitle',
                        columnId: columnId,
                        title: newTitle
                    });
                    
                    // Update local state
                    const col = currentBoard.columns.find(c => c.id === columnId);
                    if (col) {
                        col.title = newTitle;
                        titleElement.textContent = newTitle;
                    }
                }
                
                titleElement.style.display = 'block';
                editElement.style.display = 'none';
                dragHandle.draggable = true; // Re-enable dragging
            };
            
            const cancelEdit = () => {
                editElement.value = titleElement.textContent;
                titleElement.style.display = 'block';
                editElement.style.display = 'none';
                dragHandle.draggable = true; // Re-enable dragging
            };
            
            editElement.onblur = saveTitle;
            editElement.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveTitle();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            };
        }

        // Column operations
        function insertColumnBefore(columnId) {
            showInputModal(
                'Insert Column Before',
                'Enter column title:',
                'Column title...',
                title => {
                    vscode.postMessage({
                        type: 'insertColumnBefore',
                        columnId: columnId,
                        title: title
                    });
                }
            );
        }

        function insertColumnAfter(columnId) {
            showInputModal(
                'Insert Column After',
                'Enter column title:',
                'Column title...',
                title => {
                    vscode.postMessage({
                        type: 'insertColumnAfter',
                        columnId: columnId,
                        title: title
                    });
                }
            );
        }

        function deleteColumn(columnId) {
            if (confirm('Are you sure you want to delete this column and all its tasks?')) {
                vscode.postMessage({
                    type: 'deleteColumn',
                    columnId: columnId
                });
            }
        }

        function sortColumn(columnId, sortType) {
            vscode.postMessage({
                type: 'sortColumn',
                columnId: columnId,
                sortType: sortType
            });
        }

        // Task operations
        function duplicateTask(taskId, columnId) {
            vscode.postMessage({
                type: 'duplicateTask',
                taskId: taskId,
                columnId: columnId
            });
        }

        function insertTaskBefore(taskId, columnId) {
            vscode.postMessage({
                type: 'insertTaskBefore',
                taskId: taskId,
                columnId: columnId
            });
        }

        function insertTaskAfter(taskId, columnId) {
            vscode.postMessage({
                type: 'insertTaskAfter',
                taskId: taskId,
                columnId: columnId
            });
        }

        function moveTaskToTop(taskId, columnId) {
            vscode.postMessage({
                type: 'moveTaskToTop',
                taskId: taskId,
                columnId: columnId
            });
        }

        function moveTaskUp(taskId, columnId) {
            vscode.postMessage({
                type: 'moveTaskUp',
                taskId: taskId,
                columnId: columnId
            });
        }

        function moveTaskDown(taskId, columnId) {
            vscode.postMessage({
                type: 'moveTaskDown',
                taskId: taskId,
                columnId: columnId
            });
        }

        function moveTaskToBottom(taskId, columnId) {
            vscode.postMessage({
                type: 'moveTaskToBottom',
                taskId: taskId,
                columnId: columnId
            });
        }

        function moveTaskToColumn(taskId, fromColumnId, toColumnId) {
            vscode.postMessage({
                type: 'moveTaskToColumn',
                taskId: taskId,
                fromColumnId: fromColumnId,
                toColumnId: toColumnId
            });
        }

        function deleteTask(taskId, columnId) {
            if (confirm('Are you sure you want to delete this task?')) {
                vscode.postMessage({
                    type: 'deleteTask',
                    taskId: taskId,
                    columnId: columnId
                });
            }
        }

        function addTask(columnId) {
            const taskData = {
                title: '',
                description: ''
            };

            vscode.postMessage({
                type: 'addTask',
                columnId: columnId,
                taskData: taskData
            });
        }

        function addColumn() {
            showInputModal(
                'Add Column',
                'Please enter column title:',
                'Enter column title...',
                title => {
                    vscode.postMessage({
                        type: 'addColumn',
                        title: title
                    });
                }
            );
        }

        // Edit functions with improved scroll stability
        function editTitle(element, taskId = null, columnId = null) {
            if (!taskId) {
                taskId = element.dataset.taskId || element.closest('.task-item').dataset.taskId;
            }
            if (!columnId) {
                columnId = element.dataset.columnId || element.closest('.task-item').dataset.columnId;
            }
            
            const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
            const displayDiv = taskItem.querySelector('.task-title-display');
            const editTextarea = taskItem.querySelector('.task-title-edit');
            
            // Store scroll position
            const scrollContainer = taskItem.closest('.tasks-container');
            const beforeEditOffset = taskItem.offsetTop - scrollContainer.scrollTop;
            
            displayDiv.style.display = 'none';
            editTextarea.style.display = 'block';
            autoResize(editTextarea);
            editTextarea.focus();
            editTextarea.select();
            
            // Maintain scroll position
            requestAnimationFrame(() => {
                const newScrollTop = taskItem.offsetTop - beforeEditOffset;
                scrollContainer.scrollTop = newScrollTop;
            });
            
            const saveAndHide = () => {
                const beforeSaveOffset = taskItem.offsetTop - scrollContainer.scrollTop;
                
                saveTaskFieldAndUpdateDisplay(editTextarea);
                editTextarea.style.display = 'none';
                displayDiv.style.display = 'block';
                
                requestAnimationFrame(() => {
                    const newScrollTop = taskItem.offsetTop - beforeSaveOffset;
                    scrollContainer.scrollTop = newScrollTop;
                });
            };
            
            const cancelEdit = () => {
                const beforeCancelOffset = taskItem.offsetTop - scrollContainer.scrollTop;
                
                editTextarea.style.display = 'none';
                displayDiv.style.display = 'block';
                
                requestAnimationFrame(() => {
                    const newScrollTop = taskItem.offsetTop - beforeCancelOffset;
                    scrollContainer.scrollTop = newScrollTop;
                });
            };
            
            editTextarea.onblur = saveAndHide;
            editTextarea.onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveAndHide();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            };
            
            editTextarea.oninput = () => autoResize(editTextarea);
        }

        function editDescription(element, taskId = null, columnId = null) {
            if (!taskId) {
                taskId = element.dataset.taskId || element.closest('.task-item').dataset.taskId;
            }
            if (!columnId) {
                columnId = element.dataset.columnId || element.closest('.task-item').dataset.columnId;
            }
            
            const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
            const displayDiv = taskItem.querySelector('.task-description-display');
            const editTextarea = taskItem.querySelector('.task-description-edit');
            const placeholder = taskItem.querySelector('.task-description-placeholder');
            
            const scrollContainer = taskItem.closest('.tasks-container');
            const beforeEditOffset = taskItem.offsetTop - scrollContainer.scrollTop;
            
            if (displayDiv) displayDiv.style.display = 'none';
            if (placeholder) placeholder.style.display = 'none';
            
            editTextarea.style.display = 'block';
            autoResize(editTextarea);
            editTextarea.focus();
            
            requestAnimationFrame(() => {
                const newScrollTop = taskItem.offsetTop - beforeEditOffset;
                scrollContainer.scrollTop = newScrollTop;
            });
            
            const saveAndHide = () => {
                const beforeSaveOffset = taskItem.offsetTop - scrollContainer.scrollTop;
                
                saveTaskFieldAndUpdateDisplay(editTextarea);
                editTextarea.style.display = 'none';
                
                requestAnimationFrame(() => {
                    const newTaskItem = document.querySelector(`[data-task-id="${taskId}"]`);
                    const newScrollContainer = newTaskItem?.closest('.tasks-container');
                    
                    if (newTaskItem && newScrollContainer) {
                        const newScrollTop = newTaskItem.offsetTop - beforeSaveOffset;
                        newScrollContainer.scrollTop = newScrollTop;
                    }
                });
            };
            
            const cancelEdit = () => {
                const beforeCancelOffset = taskItem.offsetTop - scrollContainer.scrollTop;
                
                editTextarea.style.display = 'none';
                if (editTextarea.value.trim()) {
                    displayDiv.style.display = 'block';
                } else {
                    placeholder.style.display = 'block';
                }
                
                requestAnimationFrame(() => {
                    const newScrollTop = taskItem.offsetTop - beforeCancelOffset;
                    scrollContainer.scrollTop = newScrollTop;
                });
            };
            
            editTextarea.onblur = saveAndHide;
            editTextarea.onkeydown = (e) => {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            };
            
            editTextarea.oninput = () => autoResize(editTextarea);
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function saveTaskFieldAndUpdateDisplay(textarea) {
            const taskId = textarea.dataset.taskId;
            const columnId = textarea.dataset.columnId;
            const field = textarea.dataset.field;
            const value = textarea.value.trim();

            if (!taskId || !columnId || !field) return;

            const column = currentBoard?.columns.find(col => col.id === columnId);
            const task = column?.tasks.find(t => t.id === taskId);
            
            if (!task) return;

            task[field] = value;

            const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
            
            if (field === 'title') {
                const displayDiv = taskItem.querySelector('.task-title-display');
                if (value) {
                    displayDiv.innerHTML = renderMarkdown(value);
                } else {
                    displayDiv.innerHTML = '<span class="task-title-placeholder">Add title...</span>';
                }
            } else if (field === 'description') {
                const displayDiv = taskItem.querySelector('.task-description-display');
                const placeholder = taskItem.querySelector('.task-description-placeholder');
                
                if (value) {
                    displayDiv.innerHTML = renderMarkdown(value);
                    displayDiv.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                } else {
                    displayDiv.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'block';
                }
            }

            const taskData = { ...task, [field]: value };
            vscode.postMessage({
                type: 'editTask',
                taskId: taskId,
                columnId: columnId,
                taskData: taskData
            });
        }

        function renderMarkdown(text) {
            if (!text) return '';
            
            try {
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    sanitize: false
                });
                
                const rendered = marked.parse(text);
                
                if (!text.includes('\n') && rendered.startsWith('<p>') && rendered.endsWith('</p>\n')) {
                    return rendered.slice(3, -5);
                }
                
                return rendered;
            } catch (error) {
                console.error('Error rendering markdown:', error);
                return escapeHtml(text);
            }
        }

        // Drag and drop setup
        function setupDragAndDrop() {
            setupColumnDragAndDrop();
            setupTaskDragAndDrop();
        }

        function setupColumnDragAndDrop() {
            const boardElement = document.getElementById('kanban-board');
            const columns = boardElement.querySelectorAll('.kanban-column');
            let draggedColumnId = null;

            columns.forEach(column => {
                const dragHandle = column.querySelector('.drag-handle');
                const columnId = column.getAttribute('data-column-id');

                dragHandle.addEventListener('dragstart', e => {
                    draggedColumnId = columnId;
                    e.dataTransfer.effectAllowed = 'move';
                    column.classList.add('column-dragging');
                });

                dragHandle.addEventListener('dragend', e => {
                    column.classList.remove('column-dragging');
                    draggedColumnId = null;
                    columns.forEach(col => col.classList.remove('drag-over'));
                });

                column.addEventListener('dragover', e => {
                    e.preventDefault();
                    if (draggedColumnId && draggedColumnId !== columnId) {
                        column.classList.add('drag-over');
                    }
                });

                column.addEventListener('dragleave', e => {
                    if (!column.contains(e.relatedTarget)) {
                        column.classList.remove('drag-over');
                    }
                });

                column.addEventListener('drop', e => {
                    e.preventDefault();
                    column.classList.remove('drag-over');

                    if (draggedColumnId && draggedColumnId !== columnId) {
                        const fromIndex = getOriginalColumnIndex(draggedColumnId);
                        const toIndex = getOriginalColumnIndex(columnId);
                        
                        if (fromIndex !== -1 && toIndex !== -1) {
                            vscode.postMessage({
                                type: 'moveColumn',
                                fromIndex: fromIndex,
                                toIndex: toIndex
                            });
                        }
                    }
                });
            });
        }

        function setupTaskDragAndDrop() {
            document.querySelectorAll('.kanban-column').forEach(columnElement => {
                const columnId = columnElement.dataset.columnId;
                const tasksContainer = columnElement.querySelector('.tasks-container');

                if (!tasksContainer) return;

                tasksContainer.addEventListener('dragover', e => {
                    e.preventDefault();
                    columnElement.classList.add('drag-over');
                    
                    const draggingElement = document.querySelector('.task-item.dragging');
                    if (draggingElement) {
                        const afterElement = getDragAfterTaskElement(tasksContainer, e.clientY);
                        
                        tasksContainer.querySelectorAll('.task-item').forEach(task => {
                            task.classList.remove('drag-insert-before', 'drag-insert-after');
                        });
                        
                        if (afterElement == null) {
                            const lastTask = tasksContainer.querySelector('.task-item:last-child');
                            if (lastTask && lastTask !== draggingElement) {
                                lastTask.classList.add('drag-insert-after');
                            }
                        } else if (afterElement !== draggingElement) {
                            afterElement.classList.add('drag-insert-before');
                        }
                    }
                });

                tasksContainer.addEventListener('dragleave', e => {
                    if (!columnElement.contains(e.relatedTarget)) {
                        columnElement.classList.remove('drag-over');
                        tasksContainer.querySelectorAll('.task-item').forEach(task => {
                            task.classList.remove('drag-insert-before', 'drag-insert-after');
                        });
                    }
                });

                tasksContainer.addEventListener('drop', e => {
                    e.preventDefault();
                    columnElement.classList.remove('drag-over');
                    
                    tasksContainer.querySelectorAll('.task-item').forEach(task => {
                        task.classList.remove('drag-insert-before', 'drag-insert-after');
                    });

                    const taskId = e.dataTransfer.getData('text/plain');
                    const fromColumnId = e.dataTransfer.getData('application/column-id');

                    if (taskId && fromColumnId) {
                        const dropIndex = calculateDropIndex(tasksContainer, e.clientY);
                        
                        vscode.postMessage({
                            type: 'moveTask',
                            taskId: taskId,
                            fromColumnId: fromColumnId,
                            toColumnId: columnId,
                            newIndex: dropIndex
                        });
                    }
                });

                columnElement.querySelectorAll('.task-drag-handle').forEach(handle => {
                    setupTaskDragHandle(handle);
                });
            });
        }

        function setupTaskDragHandle(handle) {
            handle.draggable = true;
            
            handle.addEventListener('dragstart', e => {
                const taskItem = e.target.closest('.task-item');
                if (taskItem) {
                    e.stopPropagation();
                    e.dataTransfer.setData('text/plain', taskItem.dataset.taskId);
                    e.dataTransfer.setData('application/column-id', taskItem.dataset.columnId);
                    e.dataTransfer.effectAllowed = 'move';
                    taskItem.classList.add('dragging');
                }
            });

            handle.addEventListener('dragend', e => {
                const taskItem = e.target.closest('.task-item');
                if (taskItem) {
                    taskItem.classList.remove('dragging');
                }
            });
        }

        function getDragAfterTaskElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function calculateDropIndex(tasksContainer, clientY) {
            const tasks = Array.from(tasksContainer.children);
            let dropIndex = tasks.length;

            for (let i = 0; i < tasks.length; i++) {
                const taskElement = tasks[i];
                const rect = taskElement.getBoundingClientRect();
                const taskCenter = rect.top + rect.height / 2;

                if (clientY < taskCenter) {
                    dropIndex = i;
                    break;
                }
            }

            return dropIndex;
        }

        function getOriginalColumnIndex(columnId) {
            if (!currentBoard) return -1;
            return currentBoard.columns.findIndex(col => col.id === columnId);
        }

        // Modal functions
        function showInputModal(title, message, placeholder, onConfirm) {
            document.getElementById('input-modal-title').textContent = title;
            document.getElementById('input-modal-message').textContent = message;
            const inputField = document.getElementById('input-modal-field');
            inputField.placeholder = placeholder;
            inputField.value = '';
            document.getElementById('input-modal').style.display = 'block';

            setTimeout(() => inputField.focus(), 100);

            const confirmAction = () => {
                const value = inputField.value.trim();
                if (value) {
                    closeInputModal();
                    onConfirm(value);
                }
            };

            const confirmBtn = document.getElementById('input-ok-btn');
            confirmBtn.onclick = confirmAction;

            inputField.onkeydown = e => {
                if (e.key === 'Enter') {
                    confirmAction();
                }
            };
        }

        function closeInputModal() {
            document.getElementById('input-modal').style.display = 'none';
        }

        document.getElementById('input-modal').addEventListener('click', e => {
            if (e.target.id === 'input-modal') {
                closeInputModal();
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>